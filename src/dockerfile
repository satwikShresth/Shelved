FROM denoland/deno:alpine

# Install runtime dependencies
RUN apk add --no-cache libstdc++

# Set working directory
WORKDIR /src

# Copy dependency files first for better layer caching
COPY deno.* ./

# Cache dependencies by running deno cache on lock file
# This will be cached unless deno.json/deno.lock changes
RUN deno cache --lock=deno.lock deno.json 2>/dev/null || true

# Copy application code
COPY . .

# Make entrypoint executable
RUN chmod +x entrypoint.sh

# Expose port
EXPOSE 3000

# Use exec form for better signal handling
ENTRYPOINT ["./entrypoint.sh"]
